<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scalar Speed Demo (Rounded + Filtered + km/h)</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  pre { background: #eee; padding: 10px; white-space: pre-wrap; }
  button { padding: 10px 20px; font-size: 16px; margin: 5px; }
</style>
</head>
<body>

<h2>Scalar Speed Demo (Rounded + Filtered + km/h)</h2>

<button id="enable">Enable Sensors</button>
<button id="cal" disabled>CALIBRATE GRAVITY</button>
<button id="zero" disabled>ZERO VELOCITY</button>

<pre id="out">Press Enable…</pre>

<script>
let lastTime = null;
let velocity = 0;     // m/s
let g_cal = 9.81;     // calibrated gravity

// moving average filter buffer
const FILTER_SIZE = 8;
let magBuffer = Array(FILTER_SIZE).fill(9.81);
let magIndex = 0;

let lastAccelMag = 9.81;

// ZERO VELOCITY
document.getElementById("zero").onclick = () => {
    velocity = 0;
};

// CALIBRATE GRAVITY
document.getElementById("cal").onclick = () => {
    g_cal = lastAccelMag; // sets gravity to the filtered magnitude
};

// enable buttons after sensor begin
function enableButtons() {
    document.getElementById("cal").disabled = false;
    document.getElementById("zero").disabled = false;
}

function startSensors() {

    enableButtons();

    window.addEventListener("devicotion", event => {});
    window.addEventListener("devicemotion", event => {
        const acc = event.accelerationIncludingGravity;
        if (!acc) return;

        const t = event.timeStamp;
        if (lastTime === null) {
            lastTime = t;
            return;
        }
        const dt = (t - lastTime) / 1000;
        lastTime = t;

        // --- ROUND RAW VALUES TO 1 DECIMAL ---
        const ax_raw = acc.x || 0;
        const ay_raw = acc.y || 0;
        const az_raw = acc.z || 0;

        const ax = Math.round(ax_raw * 10) / 10;
        const ay = Math.round(ay_raw * 10) / 10;
        const az = Math.round(az_raw * 10) / 10;

        // RAW MAGNITUDE (rounded values)
        const mag = Math.sqrt(ax*ax + ay*ay + az*az);

        // --- MOVING AVERAGE FILTER ---
        magBuffer[magIndex] = mag;
        magIndex = (magIndex + 1) % FILTER_SIZE;

        const magFiltered = magBuffer.reduce((a,b)=>a+b, 0) / FILTER_SIZE;
        lastAccelMag = magFiltered;

        // linear acceleration = filtered magnitude minus calibrated gravity
        const a_lin = magFiltered - g_cal;

        // integrate scalar acceleration
        velocity += a_lin * dt;

        // drift damping
        velocity *= 0.999;

        // convert to km/h
        const velocity_kmh = velocity * 3.6;

        document.getElementById("out").textContent = `
Rounded accel:
  ax: ${ax.toFixed(1)}
  ay: ${ay.toFixed(1)}
  az: ${az.toFixed(1)}

Raw accel mag:       ${mag.toFixed(3)} m/s²
Filtered accel mag:  ${magFiltered.toFixed(3)} m/s²
Gravity (cal):       ${g_cal.toFixed(3)} m/s²

Linear accel:        ${a_lin.toFixed(3)} m/s²

Velocity (m/s):      ${velocity.toFixed(3)}
Velocity (km/h):     ${velocity_kmh.toFixed(3)}
`;
    });
}

document.getElementById("enable").onclick = async () => {
    if (typeof DeviceMotionEvent.requestPermission === "function") {
        const resp = await DeviceMotionEvent.requestPermission();
        if (resp !== "granted") {
            alert("Permission denied.");
            return;
        }
    }
    startSensors();
    document.getElementById("enable").style.display = "none";
};
</script>

</body>
</html>
